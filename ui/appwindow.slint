import { Button, VerticalBox, LineEdit, ComboBox, HorizontalBox, TextEdit, ProgressIndicator, ScrollView, ListView } from "std-widgets.slint";

export global ModernPalette {
    // Deep, rich dark background
    out property <color> bg-gradient-start: #0f172a; // Slate 900
    out property <color> bg-gradient-end: #000000;
    
    // Glass effect
    out property <color> glass-surface: #1e293b80; // Semi-transparent slate
    out property <color> glass-border: #ffffff1a; // 10% white border
    
    // Typography
    out property <color> text-primary: #ffffff;
    out property <color> text-secondary: #94a3b8; // Slate 400
    
    // Accents (Neon Cyan/Blue)
    out property <color> accent-primary: #06b6d4; // Cyan 500
    out property <color> accent-hover: #22d3ee; // Cyan 400
    out property <color> accent-dim: #0891b2; // Cyan 600
    
    // Inputs
    out property <color> input-bg: #00000060;
}

component GlassButton inherits Rectangle {
    in property <string> text;
    in property <bool> enabled: true;
    in property <bool> primary: true;
    callback clicked;
    
    height: 42px;
    border-radius: 12px;
    
    background: !enabled ? #334155 : (primary ? ModernPalette.accent-primary : #33415580);
    border-width: 1px;
    border-color: !enabled ? #1e293b : (primary ? #ffffff40 : ModernPalette.glass-border);
    
    animate background { duration: 200ms; }
    
    touch := TouchArea {
        width: 100%; height: 100%;
        clicked => { if (root.enabled) { root.clicked(); } }
        mouse-cursor: root.enabled ? pointer : default;
    }
    
    Text {
        text: root.text;
        color: !root.enabled ? #64748b : #ffffff;
        font-weight: 600;
        font-size: 14px;
        vertical-alignment: center;
        horizontal-alignment: center;
    }
    
    states [
        hover when touch.has-hover && root.enabled: {
            background: root.primary ? ModernPalette.accent-hover : #475569;
        }
        pressed when touch.pressed && root.enabled: {
            background: root.primary ? ModernPalette.accent-dim : #1e293b;
        }
    ]
}

component GlassPanel inherits Rectangle {
    background: ModernPalette.glass-surface;
    border-radius: 16px;
    border-width: 1px;
    border-color: ModernPalette.glass-border;
}

export component AppWindow inherits Window {
    title: "YT-DLP Modern";
    min-width: 800px;
    min-height: 600px;
    background: @linear-gradient(135deg, ModernPalette.bg-gradient-start, ModernPalette.bg-gradient-end);

    in property <string> status_text: "System Ready";
    in property <string> full_log: "Initialize...\n";
    in property <float> download_progress: 0.0;
    in property <bool> is_downloading: false;
    in property <string> download_path: "downloads";
    
    callback start_download(string, string, string);
    callback choose_path();

    VerticalBox {
        padding: 40px;
        spacing: 30px;

        // Header
        VerticalBox {
            spacing: 5px;
            alignment: center;
            Text {
                text: "YouTube Downloader";
                font-size: 32px;
                font-weight: 800;
                color: ModernPalette.text-primary;
                horizontal-alignment: center;
            }
            Text {
                text: "Professional High-Speed Downloader";
                font-size: 14px;
                color: ModernPalette.text-secondary;
                horizontal-alignment: center;
            }
        }

        // Main Controls
        GlassPanel {
            VerticalBox {
                padding: 24px;
                spacing: 20px;

                // Path Selector
                HorizontalBox {
                    spacing: 12px;
                    Text { 
                        text: "Location"; 
                        vertical-alignment: center; 
                        color: ModernPalette.text-secondary; 
                        width: 70px;
                        font-size: 13px;
                    }
                    path_field := Rectangle {
                        background: ModernPalette.input-bg;
                        border-radius: 8px;
                        border-width: 1px;
                        border-color: ModernPalette.glass-border;
                        height: 42px;
                        horizontal-stretch: 1;
                        
                        Text {
                            x: 12px;
                            text: root.download_path;
                            color: ModernPalette.text-primary;
                            vertical-alignment: center;
                            height: 100%;
                            overflow: elide;
                        }
                    }
                    GlassButton {
                        text: "Browse";
                        primary: false;
                        width: 90px;
                        clicked => { root.choose_path(); }
                    }
                }

                // URL Input
                HorizontalBox {
                    spacing: 12px;
                    Text { 
                        text: "URL"; 
                        vertical-alignment: center; 
                        color: ModernPalette.text-secondary; 
                        width: 70px;
                        font-size: 13px;
                    }
                    url_input := LineEdit {
                        placeholder-text: "https://youtube.com/watch?v=...";
                        font-size: 14px;
                        height: 42px;
                        horizontal-stretch: 1;
                    }
                }

                // Options Row
                HorizontalBox {
                    spacing: 20px;
                    
                    // Format
                    HorizontalBox {
                        spacing: 12px;
                        width: 50%;
                        Text { 
                            text: "Format"; 
                            vertical-alignment: center; 
                            color: ModernPalette.text-secondary; 
                            width: 70px;
                            font-size: 13px;
                        }
                        format_combo := ComboBox {
                            model: ["Video (MP4)", "Audio (MP3)"];
                            current-value: "Video (MP4)";
                            height: 42px;
                            horizontal-stretch: 1;
                        }
                    }
                    
                    // Quality
                    HorizontalBox {
                        spacing: 12px;
                        width: 50%;
                        Text { 
                            text: "Quality"; 
                            vertical-alignment: center; 
                            color: ModernPalette.text-secondary; 
                            width: 60px;
                            font-size: 13px;
                        }
                        quality_combo := ComboBox {
                            model: ["Best", "1080p", "720p", "480p", "Audio Only"];
                            current-value: "Best";
                            height: 42px;
                            horizontal-stretch: 1;
                        }
                    }
                }
            }
        }

        // Progress Section
        if (root.download_progress > 0.0 || root.is_downloading): VerticalBox {
             spacing: 8px;
             HorizontalBox {
                 Text { text: root.is_downloading ? "Downloading..." : "Complete"; color: ModernPalette.text-secondary; font-size: 12px; }
                 Text { text: Math.round(root.download_progress * 100) + "%"; color: ModernPalette.accent-primary; horizontal-alignment: right; font-weight: 700; }
             }
             
             Rectangle {
                 height: 6px;
                 background: #334155;
                 border-radius: 3px;
                 clip: true;
                 
                 Rectangle {
                     x: 0;
                     width: parent.width * root.download_progress;
                     height: 100%;
                     background: ModernPalette.accent-primary;
                     border-radius: 3px;
                     animate width { duration: 250ms; easing: ease-out; }
                     
                     // Glow
                     // drop-shadow-blur: 4px; // Not supported on Rectangle in current Slint version clearly?
                     // Workaround for glow: no easy way without images or custom shader, keeping clean flat neon
                 }
             }
        }

        // Main Action
        GlassButton {
            text: root.is_downloading ? "PROCESSING..." : "START DOWNLOAD";
            height: 50px;
            enabled: !root.is_downloading && url_input.text != "";
            clicked => {
                root.start_download(url_input.text, format_combo.current-value, quality_combo.current-value);
            }
        }
        
        // Logs
        GlassPanel {
            VerticalBox {
                padding: 12px;
                spacing: 8px;
                Text { text: "Terminal Output"; color: ModernPalette.text-secondary; font-size: 11px; font-weight: 700; }
                
                Rectangle {
                    background: #0f172a;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: ModernPalette.glass-border;
                    height: 120px;
                    
                    TextEdit {
                        text: root.full_log;
                        font-size: 11px;
                        // font-family: "Consolas"; // Removing to avoid build error risks, strictly utilizing default monospace if possible or default font
                        read-only: true;
                        wrap: word-wrap;
                        // color: #94a3b8; // Setting color on TextEdit might have issues? trying safely
                    }
                }
            }
        }
    }
}
